<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EQ AI Research Hub - Phase 2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="assets/images/favicon.png">
</head>
<body>
    <a class="skip-link" href="#main">Skip to main content</a>
    <header>
        <h1><a class="logo" href="#" id="logo-link">EQ AI Research Hub</a></h1>
        <div id="logo-menu" class="logo-menu">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="expert-collaborators.html">Our Team of Experts</a></li>
                <li>
                    <a href="research.html">Our Research</a>
                    <ul>
                        <li><a href="phase1.html">Phase 1</a></li>
                        <li><a href="phase2.html">Phase 2</a></li>
                        <li><a href="phase3.html">Phase 3</a></li>
                        <li><a href="phase4.html">Phase 4</a></li>
                    </ul>
                </li>
                <li><a href="https://github.com/maxaeon/EQ-bench">GitHub Repository</a></li>
            </ul>
        </div>
        <button class="nav-toggle" aria-label="Toggle navigation">&#9776;</button>
        <nav class="site-nav" aria-label="Primary">
            <span class="nav-label">Tentative Axes</span>
            <ul>
                <li><a href="sense.html">Sense</a></li>
                <li><a href="explain.html">Explain</a></li>
                <li><a href="respond.html">Respond</a></li>
                <li><a href="adapt.html">Adapt</a></li>
                <li><a href="extended.html">Extended</a></li>
            </ul>
        </nav>
    </header>

    <main id="main" class="wide">
        <section>
            <h1>Phase 2: Construct Refinement and Validation</h1>
            <div class="subsection">
                <h3>Goal</h3>
                <p>Refine and validate constructs through interdisciplinary review.</p>
            </div>
            <div class="subsection">
                <h3>Methodology</h3>
                <ul>
                    <li>Interdisciplinary workshops and Delphi method</li>
                    <li>Peer-reviewed qualitative validation and roundtable discussions</li>
                </ul>
            </div>
        </section>

        <section id="constructs">
            <hr>
            <h2>Tentative Starting Point</h2>
            <p>Undergoing development by an interdisciplinary team of experts in psychology, computer science, philosophy, and more.</p>
<p>Notice something missing? Use the <strong>Add Construct</strong> button to submit new entries. You will be prompted to log in before adding entries.</p>
            <div class="search-controls">
                <label for="construct-search">Search:</label>
                <input type="search" id="construct-search" placeholder="Search constructs">
            </div>
            <div class="add-construct-controls">
                <button id="add-construct-btn" class="button" type="button">Add Construct</button>
            </div>
            <div class="controls-row">
                <div class="filter-controls">
                    <label for="axis-filter">Axis:</label>
                    <select id="axis-filter" multiple size="1">
                        <option value="">All</option>
                    </select>
                    <label for="field-filter">Field/Topic:</label>
                    <select id="field-filter" multiple size="1">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="sort-controls">
                    <label for="sort-select">Sort by:</label>
                    <select id="sort-select">
                        <option value="title">Alphabetical</option>
                        <option value="relevance">Relevance</option>
                    </select>
                </div>
            </div>
            <div class="table-scroll">
            <table id="construct-table">
                <thead>
                    <tr>
                        <th>Construct</th>
                        <th>Definition</th>
                        <th>Example</th>
                        <th>Axis</th>
                        <th>Authors &amp; Sources</th>
                        <th>Significance <span class="info-icon" title="0 = not significant, 5 = highly significant">?</span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
        </section>
        <div class="construct-controls">
            <button id="edit-construct-btn" class="button">Edit</button>
            <button id="delete-construct-btn" class="button">Delete</button>
        </div>

    </main>

    <footer>
        <p>&copy; EQ AI Research Collaborative</p>
    </footer>
    <script>
    let constructs = [];
    let literatureCache = null;

    function parseMeta(c) {
        const body = (c.body || '').toLowerCase();
        const axes = ['sense','explain','respond','adapt','extended'];
        let foundAxes = [];
        if (c.axes) {
            if (Array.isArray(c.axes)) {
                foundAxes = c.axes.map(a => String(a).trim().toLowerCase());
            } else {
                foundAxes = c.axes.split(',').map(a => a.trim().toLowerCase());
            }
        } else {
            foundAxes = axes.filter(a => body.includes(a));
        }
        c.axis = foundAxes.join(', ');
        if (c.category) {
            c.field = c.category.toLowerCase();
        } else {
            const fields = ['psychology','philosophy and ethics','neuroscience','computer science'];
            const foundFields = fields.filter(f => body.includes(f));
            c.field = foundFields.length ? foundFields.join(', ') : 'other';
        }
        if (c.measurement) {
            c.evaluation = c.measurement;
        } else {
            const evalMatch = (c.body || '').match(/(?:evaluation|ai test task idea)[:\-]?\s*(.*)/i);
            c.evaluation = evalMatch ? evalMatch[1].trim() : '';
        }
        if (c.references && !Array.isArray(c.references)) {
            c.references = c.references.split(',').map(r => r.trim()).filter(Boolean);
        }
    }

    function toTitle(text) {
        return text.replace(/(^|\s)\S/g, t => t.toUpperCase());
    }

    async function getLiterature() {
        if (literatureCache) return literatureCache;
        let lit = [];
        const useSupabase = window.SUPABASE_URL && window.SUPABASE_ANON_KEY && typeof fetchLiterature === 'function';
        if (useSupabase) {
            for (let i=0; i<20 && !window.supabase && !supabase; i++) await new Promise(r=>setTimeout(r,100));
            if (window.supabase || supabase) {
                try { lit = await fetchLiterature(); } catch(e) { console.error(e); lit = []; }
            }
        } else {
            try { lit = await (await fetch('data/literature.json')).json(); } catch(e) { lit = []; }
        }
        literatureCache = lit;
        return lit;
    }

    async function populateLiteratureSelect(select, selected=[]) {
        const lit = await getLiterature();
        select.innerHTML = '';
        const selSet = selected.map(String);
        const getLastName = auth => {
            if (!auth) return '';
            const first = auth.split(/,|\band\b/)[0].trim();
            const parts = first.split(/\s+/);
            return parts[parts.length - 1].toLowerCase();
        };
        const sorted = [...lit].sort((a,b)=>getLastName(a.authors).localeCompare(getLastName(b.authors)));
        sorted.forEach(l => {
            const val = l.id ?? l.title;
            const text = `${l.authors} (${l.year})`;
            const opt = new Option(text, val);
            if (selSet.includes(String(val))) opt.selected = true;
            select.appendChild(opt);
        });
        enableMultiSelectDropdown(select);
    }

    function render(data) {
        const tbody = document.querySelector('#construct-table tbody');
        tbody.innerHTML = '';
        data.forEach((c, idx) => {
            const row = document.createElement('tr');
            row.className = 'construct-row';
            row.dataset.cid = c.id ?? c.__index;
            row.id = `construct-row-${c.id ?? c.__index}`;
            const extra = document.createElement('tr');
            const id = `cdetail-${c.__index}`;
            const synonyms = Array.isArray(c.synonyms) ? c.synonyms.join(', ') : (c.synonyms || '');
            const related = Array.isArray(c.related_terms) ? c.related_terms.join(', ') : (c.related_terms || '');
            const refs = Array.isArray(c.references) ? c.references.join(', ') : (c.references || '');
            const issues = c.verification_issues || '';

            row.dataset.target = id;
            row.innerHTML = `
                <td>${c.title}</td>
                <td>${c.definition || ''}</td>
                <td>${c.example || ''}</td>
                <td>${c.axis}</td>
                <td></td>
                <td><div class="star-rating construct-rating" data-index="${c.__index}"></div></td>`;

            extra.className = 'construct-extra';
            extra.id = id;
            extra.style.display = 'none';
            extra.innerHTML = `
                <td colspan="6"><strong>synonyms:</strong> ${synonyms}<br>
                <strong>related terms:</strong> ${related}<br>
                <strong>Related Literature:</strong> ${refs}<br>
                ${c.evaluation ? `<strong>How to Measure:</strong> ${c.evaluation}<br>` : ''}
                <strong>Potential Issues:</strong> ${issues}<br>
                ${c.category ? `<strong>Category:</strong> ${c.category}<br>` : ''}
                ${c.url ? `<strong>URL:</strong> <a href="${c.url}">${c.url}</a>` : ''}</td>`;

            tbody.appendChild(row);
            tbody.appendChild(extra);
        });

        tbody.querySelectorAll('.construct-row').forEach(r => {
            r.addEventListener('click', e => {
                if (e.target.closest('.star-rating')) return;
                tbody.querySelectorAll('.construct-row').forEach(x => x.classList.remove('selected'));
                r.classList.add('selected');
                selectedConstructId = r.dataset.cid || r.id.replace('construct-row-','');
                const target = document.getElementById(r.dataset.target);
                if (target) {
                    target.style.display = target.style.display === 'none' || !target.style.display ? 'table-row' : 'none';
                }
            });
        });
        initRatings('.construct-rating', 'construct-rating');
    }



    function applyConstructFilters() {
        const q = document.getElementById('construct-search').value.trim().toLowerCase();
        const axisSel = Array.from(document.getElementById('axis-filter').selectedOptions).map(o=>o.value).filter(Boolean);
        const fieldSel = Array.from(document.getElementById('field-filter').selectedOptions).map(o=>o.value).filter(Boolean);
        let items = constructs.filter(c => {
            if (axisSel.length && !axisSel.some(a => (c.axis || '').toLowerCase().includes(a))) return false;
            if (fieldSel.length && !fieldSel.some(f => (c.field || '').toLowerCase().includes(f))) return false;
            if (q) {
                const title = (c.title || '').toLowerCase();
                const def = (c.definition || '').toLowerCase();
                const syn = Array.isArray(c.synonyms) ? c.synonyms.join(' ').toLowerCase() : (c.synonyms || '').toLowerCase();
                const refs = Array.isArray(c.references) ? c.references.join(' ').toLowerCase() : (c.references || '').toLowerCase();
                return title.includes(q) || def.includes(q) || syn.includes(q) || refs.includes(q);
            }
            return true;
        });

        const sortVal = document.getElementById('sort-select').value;
        if (sortVal === 'title') {
            items.sort((a,b)=>a.title.localeCompare(b.title));
        } else if (sortVal === 'relevance') {
            const qtext = q;
            const rank = c => {
                if (!qtext) return 0;
                const text = (
                    (c.title || '') + ' ' +
                    (c.definition || '') + ' ' +
                    (Array.isArray(c.synonyms) ? c.synonyms.join(' ') : c.synonyms || '') + ' ' +
                    (Array.isArray(c.references) ? c.references.join(' ') : c.references || '')
                ).toLowerCase();
                const idx = text.indexOf(qtext);
                return idx === -1 ? Number.MAX_SAFE_INTEGER : idx;
            };
            items.sort((a,b)=>rank(a)-rank(b));
        }
        render(items);
    }

    async function loadConstructs() {
        let data = [];
        const useSupabase = window.SUPABASE_URL && window.SUPABASE_ANON_KEY && typeof fetchConstructs === 'function';
        if (useSupabase) {
            for (let i=0; i<20 && !window.supabase && !supabase; i++) await new Promise(r=>setTimeout(r,100));
            if (window.supabase || supabase) {
                try { data = await fetchConstructs(); } catch(e) { console.error(e); data = []; }
            }
        } else {
            try { data = await (await fetch('data/construct_submissions.json')).json(); } catch(e) { data = []; }
        }
        data.forEach((c, i) => { parseMeta(c); c.significance = c.significance || 0; c.__index = i; });
        constructs = data;

            const axisSet = new Set();
            const fieldSet = new Set();
            constructs.forEach(c => {
                c.axis.split(',').forEach(a => axisSet.add(a.trim()));
                if (c.field) fieldSet.add(c.field.trim().toLowerCase());
            });

            const axisFilter = document.getElementById('axis-filter');
            const axisOrder = ['sense','explain','respond','adapt','extended'];
            axisOrder.forEach(a => {
                if (axisSet.has(a))
                    axisFilter.appendChild(new Option(a.charAt(0).toUpperCase()+a.slice(1), a));
            });

            const fieldFilter = document.getElementById('field-filter');
            const fieldOrder = ['philosophy and ethics','psychology','computer science','neuroscience','other'];
            fieldOrder.forEach(f => {
                if (fieldSet.has(f))
                    fieldFilter.appendChild(new Option(toTitle(f), f));
            });

            enableMultiSelectDropdown(axisFilter);
            enableMultiSelectDropdown(fieldFilter);

            document.getElementById('sort-select').value = 'title';
            applyConstructFilters();

            document.getElementById('sort-select').addEventListener('change', applyConstructFilters);
            document.getElementById('axis-filter').addEventListener('change', applyConstructFilters);
            document.getElementById('field-filter').addEventListener('change', applyConstructFilters);
            document.getElementById('construct-search').addEventListener('input', applyConstructFilters);
    }

document.addEventListener('DOMContentLoaded', loadConstructs);
let authed = false;
let selectedConstructId = null;

async function startAddConstruct() {
    if (!authed) { if (!(await authenticate())) return; authed = true; }
    document.getElementById('construct-add-row')?.remove();
    const tbody = document.querySelector('#construct-table tbody');
    const addRow = document.createElement('tr');
    addRow.id = 'construct-add-row';
    addRow.innerHTML = `<td colspan="6"><form id="construct-add-form">
        <label>Title: <input type="text" name="title" required></label>
        <label>Axes: <select name="axes" multiple size="1">
            <option value="sense">Sense</option>
            <option value="explain">Explain</option>
            <option value="respond">Respond</option>
            <option value="adapt">Adapt</option>
            <option value="extended">Extended</option>
        </select></label>
        <label>Definition: <textarea name="definition" rows="3"></textarea></label>
        <label>Example: <textarea name="example" rows="2"></textarea></label>
        <label>Synonyms: <input type="text" name="synonyms" placeholder="comma separated"></label>
        <label>Related Terms: <input type="text" name="related_terms" placeholder="comma separated"></label>
        <label>How to Measure: <textarea name="measurement" rows="2"></textarea></label>
        <label>Potential Issues: <textarea name="verification_issues" rows="2"></textarea></label>
        <label>Category: <input type="text" name="category"></label>
        <label>Related Literature: <select name="references" multiple size="1"></select></label>
        <label>URL: <input type="url" name="url"></label>
        <button type="submit">Add</button>
        <button type="button" id="construct-add-cancel">Cancel</button>
        <div class="form-error" style="display:none"></div>
    </form></td>`;
    tbody.prepend(addRow);
    const form = document.getElementById('construct-add-form');
    const errorDiv = form.querySelector('.form-error');
    enableMultiSelectDropdown(form.elements.axes);
    populateLiteratureSelect(form.elements.references);
    form.addEventListener('submit', async e => {
        e.preventDefault();
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
        if (!authed) { if (!(await authenticate())) return; authed = true; }
        const axesArr = Array.from(form.elements.axes.selectedOptions).map(o => o.value);
        const refsArr = Array.from(form.elements.references.selectedOptions).map(o => o.value);
        const parseList = str => str.split(',').map(v => v.trim()).filter(Boolean);
        const obj = {
            title: e.target.title.value,
            axes: axesArr,
            references: refsArr,
            definition: e.target.definition.value,
            example: e.target.example.value,
            synonyms: parseList(e.target.synonyms.value),
            related_terms: parseList(e.target.related_terms.value),
            measurement: e.target.measurement.value,
            verification_issues: e.target.verification_issues.value,
            category: e.target.category.value,
            url: e.target.url.value,
            significance: 0
        };
        if (typeof addConstruct === 'function') {
            try {
                const { data, error } = await addConstruct(obj);
                if (error) {
                    errorDiv.textContent = error.message || error;
                    errorDiv.style.display = 'block';
                    return;
                }
                if (data && data[0]) Object.assign(obj, data[0]);
            } catch (err) {
                console.error(err);
                errorDiv.textContent = err.message || err;
                errorDiv.style.display = 'block';
                return;
            }
        }
        obj.axis = axesArr.join(', ');
        obj.__index = Math.max(0, ...constructs.map(c => c.__index || 0)) + 1;
        constructs.push(obj);
        addRow.remove();
        applyConstructFilters();
    });
    document.getElementById('construct-add-cancel').addEventListener('click', () => addRow.remove());
}



async function startEditConstruct() {
    if (!authed) { if (!(await authenticate())) return; authed = true; }
    if (selectedConstructId === null) { alert('Select an entry first.'); return; }
    const item = constructs.find(c => (c.id ?? c.__index) == selectedConstructId);
    if (!item) return;
    const axesVals = Array.isArray(item.axes) ? item.axes : (item.axes || '').split(',').map(a=>a.trim());
    const formHtml = `<form id="construct-edit-form">
        <label>Title: <input type="text" name="title" value="${item.title}" placeholder="Construct name"></label>
        <label>Axes: <select name="axes" multiple size="1">
            <option value="sense" ${axesVals.includes('sense') ? 'selected' : ''}>Sense</option>
            <option value="explain" ${axesVals.includes('explain') ? 'selected' : ''}>Explain</option>
            <option value="respond" ${axesVals.includes('respond') ? 'selected' : ''}>Respond</option>
            <option value="adapt" ${axesVals.includes('adapt') ? 'selected' : ''}>Adapt</option>
            <option value="extended" ${axesVals.includes('extended') ? 'selected' : ''}>Extended</option>
        </select></label>
        <label>Definition: <textarea name="definition" rows="3" placeholder="Short description">${item.definition || ''}</textarea></label>
        <label>Example: <textarea name="example" rows="2" placeholder="Brief example">${item.example || ''}</textarea></label>
        <label>Synonyms: <input type="text" name="synonyms" placeholder="comma separated" value="${Array.isArray(item.synonyms) ? item.synonyms.join(', ') : (item.synonyms || '')}"></label>
        <label>Related Terms: <input type="text" name="related_terms" placeholder="comma separated" value="${Array.isArray(item.related_terms) ? item.related_terms.join(', ') : (item.related_terms || '')}"></label>
        <label>How to Measure: <textarea name="measurement" rows="2" placeholder="How to measure">${item.measurement || ''}</textarea></label>
        <label>Potential Issues: <textarea name="verification_issues" rows="2" placeholder="Verification caveats">${item.verification_issues || ''}</textarea></label>
        <label>Category: <input type="text" name="category" placeholder="Field" value="${item.category || ''}"></label>
        <label>Related Literature: <select name="references" multiple size="1"></select></label>
        <label>URL: <input type="url" name="url" placeholder="Source link" value="${item.url || ''}"></label>
        <div class="edit-buttons">
            <button type="submit" class="button">Save</button>
            <button type="button" id="construct-edit-cancel" class="button">Cancel</button>
        </div>
    </form>`;
    const form = showEditOverlay(formHtml);
    enableMultiSelectDropdown(form.elements.axes);
    const currentRefs = Array.isArray(item.references) ? item.references : (item.references || '').split(',').map(r=>r.trim()).filter(Boolean);
    populateLiteratureSelect(form.elements.references, currentRefs);
    form.addEventListener('submit', async e => {
        e.preventDefault();
        if (!authed) { if (!(await authenticate())) return; authed = true; }
        if (!confirm('Save changes?')) return;
        const axesArr = Array.from(form.elements.axes.selectedOptions).map(o => o.value);
        const refsArr = Array.from(form.elements.references.selectedOptions).map(o => o.value);
        const parseList = str => str.split(',').map(v => v.trim()).filter(Boolean);
        item.title = form.title.value;
        item.axes = axesArr;
        item.axis = axesArr.join(', ');
        item.definition = form.definition.value;
        item.example = form.example.value;
        item.synonyms = parseList(form.synonyms.value);
        item.related_terms = parseList(form.related_terms.value);
        item.measurement = form.measurement.value;
        item.verification_issues = form.verification_issues.value;
        item.category = form.category.value;
        item.url = form.url.value;
        item.references = refsArr;
        if (item.id && typeof updateConstruct === 'function') await updateConstruct(item.id, {
            title: item.title,
            axes: axesArr,
            definition: item.definition,
            example: item.example,
            synonyms: item.synonyms,
            related_terms: item.related_terms,
            measurement: item.measurement,
            verification_issues: item.verification_issues,
            category: item.category,
            url: item.url,
            references: refsArr
        });
        hideEditOverlay();
        applyConstructFilters();
    });
    document.getElementById('construct-edit-cancel').addEventListener('click', hideEditOverlay);
}

async function deleteSelectedConstruct() {
    if (selectedConstructId === null) { alert('Select an entry first.'); return; }
    const idx = constructs.findIndex(c => (c.id ?? c.__index) == selectedConstructId);
    if (idx === -1) return;
    if (!authed) { if (!(await authenticate())) return; authed = true; }
    if (!confirm('Delete this construct?')) return;
    const item = constructs[idx];
    if (item.id && typeof deleteConstruct === 'function') await deleteConstruct(item.id);
    constructs.splice(idx,1);
    selectedConstructId = null;
    applyConstructFilters();
}

document.getElementById('edit-construct-btn').addEventListener('click', startEditConstruct);
document.getElementById('delete-construct-btn').addEventListener('click', deleteSelectedConstruct);
document.getElementById('add-construct-btn').addEventListener('click', startAddConstruct);

// Confirm before saving new or updated constructs
document.getElementById('construct-form')?.addEventListener('submit', e => {
    if (!confirm('Save changes?')) {
        e.preventDefault();
    }
});
    </script>
    <script src="env.js"></script>
    <script src="script.js"></script>
</body>
</html>
